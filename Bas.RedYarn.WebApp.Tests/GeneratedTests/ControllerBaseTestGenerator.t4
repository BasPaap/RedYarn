<#@ include file="$(SolutionDir)common.t4" #><#+
private void WriteTestClass(string unitUnderTestName)
{
	var controllerName = $"{unitUnderTestName}Controller";
	WriteBeginning(controllerName);
	WriteTests(controllerName);
	WriteEnd();
}

private void WriteBeginning(string unitUnderTestName)
{
#>using Bas.RedYarn.WebApp.Tests.Extensions;
using Bas.RedYarn.WebApp.Tests.Helpers;
using Bas.RedYarn.WebApp.Tests.Services;
using Bas.RedYarn.WebApp.ViewModels;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Linq;
using System.Net.Http;

namespace Bas.RedYarn.WebApp.Tests
{
	[TestClass]
    public partial class <#= unitUnderTestName #>Test
    {
		private TestDataService dataService;
        private HttpClient httpClient;
		
        [TestInitialize]
        public void Initialize()
        {
			this.dataService = new TestDataService();
			this.httpClient = TestServerHelper.GetTestClient(this.dataService);
        }
<#+
}

private void WriteEnd()
{
#>
	}
}
<#+
}

private void WriteKeyAssert(string subjectName, string viewModelInstanceName)
{
	if (modelsWithCompositeKeys.Keys.Contains(subjectName))
	{
		foreach (var key in modelsWithCompositeKeys[subjectName])
		{
			WriteLine($"\t\t\tAssert.AreEqual({viewModelInstanceName}.{key}, this.dataService.{subjectName}ViewModels.Single().{key});");
		}
	}
	else
	{
		WriteLine($"\t\t\tAssert.AreEqual({viewModelInstanceName}.Id, this.dataService.{subjectName}ViewModels.Single().Id);");
	}
}

private void WriteKeyAssert(string subjectName, string viewModelInstanceName, string owningInstanceName)
{
	if (modelsWithCompositeKeys.Keys.Contains(subjectName))
	{
		foreach (var key in modelsWithCompositeKeys[subjectName])
		{
			WriteLine($"\t\t\tAssert.AreEqual({viewModelInstanceName}.{key}, {owningInstanceName}.{key});");
		}
	}
	else
	{
		WriteLine($"\t\t\tAssert.AreEqual({viewModelInstanceName}.Id, this.dataService.{subjectName}ViewModels.Single().Id);");
	}
}

private void WriteInvalidIdPath(string subjectName)
{
	if (modelsWithCompositeKeys.Keys.Contains(subjectName))
	{
		for (int i=0; i < modelsWithCompositeKeys[subjectName].Count; ++i)
		{
			Write(Guid.NewGuid().ToString() + "/");
		}
	}
	else
	{
		Write(Guid.NewGuid().ToString());
	}
}

private string GetSubjectName(string unitUnderTestName)
{
	return unitUnderTestName.Substring(0, unitUnderTestName.IndexOf("Controller"));
}

private void WriteTests(string unitUnderTestName)
{
	string subjectName = GetSubjectName(unitUnderTestName);			// "Diagram"
	string viewModelTypeName = subjectName + "ViewModel";			// "DiagramViewModel"
	string viewModelInstanceName = Decapitalize(viewModelTypeName); // "diagramViewModel"
	string controllerObjectName = Decapitalize(unitUnderTestName);	// "diagramController"

	WriteCreateTests(unitUnderTestName, subjectName, viewModelTypeName, viewModelInstanceName, controllerObjectName);
	WriteUpdateTests(unitUnderTestName, subjectName, viewModelTypeName, viewModelInstanceName, controllerObjectName);
	WriteDeleteTests(unitUnderTestName, subjectName, viewModelTypeName, viewModelInstanceName, controllerObjectName);
	WriteGetTests(unitUnderTestName, subjectName, viewModelTypeName, viewModelInstanceName, controllerObjectName);
}

private void WriteCreateTests(string unitUnderTestName, string subjectName, string viewModelTypeName, string viewModelInstanceName, string controllerObjectName)
{
#>

		#region Create
		[TestMethod]
		public void Create<#= subjectName #>_ArgumentIsOk_CreatesObjectAndReturns201Created()
		{
<#+
	if (subjectName == nameof(Relationship))
	{#>
			var firstCharacter = new CharacterViewModel()
			{
				Id = Guid.NewGuid(),
				Name = "FirstCharacter"
			};
			this.dataService.CharacterViewModels.Add(firstCharacter);

			var secondCharacter = new CharacterViewModel()
			{
				Id = Guid.NewGuid(),
				Name = "SecondCharacter"
			};
			this.dataService.CharacterViewModels.Add(secondCharacter);
<#+	}

#>			// Arrange
			var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
			{
<#+
	if (subjectName == nameof(Relationship))
	{
#>				FirstCharacterId = firstCharacter.Id,
				SecondCharacterId = secondCharacter.Id,
<#+	}
#>				Name = "New<#=viewModelTypeName#>"
			};
<#+			if (entitiesToAddToDiagram.Contains(subjectName))
			{
#>			var diagramViewModel = new DiagramViewModel()
            {
                Name = "Diagram",
                Id = Guid.NewGuid()
            };
            this.dataService.DiagramViewModels.Add(diagramViewModel);
<#+			}#>

			// Act
			var result = (httpClient.PostAsync($"api/<#= subjectName #><#+ if (entitiesToAddToDiagram.Contains(subjectName)) { #>/{diagramViewModel.Id}<#+}#>", <#=viewModelInstanceName#>.ToJsonStringContent())).Result;

			// Assert
            var content = result.Content.FromJsonString<<#=viewModelTypeName#>>();
			Assert.IsNotNull(result);
            Assert.IsNotNull(content);
			Assert.AreEqual(System.Net.HttpStatusCode.Created, result.StatusCode);
            Assert.AreEqual($"/api/<#=subjectName#>/<#=GetIdPath(subjectName, "content")#>", result.Headers.Location.PathAndQuery);
			Assert.AreEqual(<#=viewModelInstanceName#>.Name, this.dataService.<#=subjectName#>ViewModels.Single().Name);<#+
		WriteKeyAssert(subjectName, "content"); 
#>		}

		[TestMethod]
        public void Create<#=subjectName#>_WithInvalidModel_Returns400BadRequest()
        {
            // Arrange
<#+			if (entitiesToAddToDiagram.Contains(subjectName))
			{#>
			var diagramViewModel = new DiagramViewModel()
            {
                Name = "Diagram",
                Id = Guid.NewGuid()
            };
            this.dataService.DiagramViewModels.Add(diagramViewModel);
<#+			}#>
            
            // Act
<#+ if (subjectName == nameof(Relationship))
    {#>
			var result = (httpClient.PostAsync($"api/<#=subjectName#><#+ if (entitiesToAddToDiagram.Contains(subjectName)) { #>/{diagramViewModel.Id}<#+}#>", (new System.Text.StringBuilder()).ToJsonStringContent())).Result;
<#+	}
	else
	{#>
	        var result = (httpClient.PostAsync($"api/<#=subjectName#><#+ if (entitiesToAddToDiagram.Contains(subjectName)) { #>/{diagramViewModel.Id}<#+}#>", (new <#=viewModelTypeName#>()).ToJsonStringContent())).Result;
<#+	}#>
            // Assert          
            Assert.AreEqual(System.Net.HttpStatusCode.BadRequest, result.StatusCode);
        }

        [TestMethod]
        public void Create<#=subjectName#>_WithoutContent_Returns400BadRequest()
        {
            // Arrange
            var httpClient = TestServerHelper.GetTestClient(this.dataService);
<#+			if (entitiesToAddToDiagram.Contains(subjectName))
			{#>
			var diagramViewModel = new DiagramViewModel()
            {
                Name = "Diagram",
                Id = Guid.NewGuid()
            };
            this.dataService.DiagramViewModels.Add(diagramViewModel);
<#+			}#>

            // Act
            var result = (httpClient.PostAsync($"api/<#=subjectName#><#+ if (entitiesToAddToDiagram.Contains(subjectName)) { #>/{diagramViewModel.Id}<#+}#>", null)).Result;

            // Assert          
            Assert.AreEqual(System.Net.HttpStatusCode.BadRequest, result.StatusCode);
        }
		#endregion

<#+
}
#>

<#+
private void WriteUpdateTests(string unitUnderTestName, string subjectName, string viewModelTypeName, string viewModelInstanceName, string controllerObjectName)
{
#>
		#region Update
		[TestMethod]
        public void Update<#=subjectName#>_ArgumentIsOk_Updates<#=subjectName#>AndReturns204NoContent()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
                Name = "New<#=subjectName#>"
            };

            var updated<#=viewModelTypeName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t", viewModelInstanceName)#>,
                Name = "UpdatedNew<#=subjectName#>"
            };

            this.dataService.<#=Pluralize(viewModelTypeName)#>.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.PutAsync($"api/<#=subjectName#>/<#=GetIdPath(subjectName, viewModelInstanceName)#>", updated<#=viewModelTypeName#>.ToJsonStringContent())).Result;

            // Assert
            Assert.AreEqual(System.Net.HttpStatusCode.NoContent, result.StatusCode);
			<#+ WriteKeyAssert(subjectName, viewModelInstanceName); #>			
            Assert.AreEqual(updated<#=viewModelTypeName#>.Name, this.dataService.<#=Pluralize(viewModelTypeName)#>.Single().Name);
        }

        [TestMethod]
        public void Update<#=subjectName#>_ArgumentIsNull_Returns400BadRequest()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
                Name = "New<#=subjectName#>"
            };

            this.dataService.<#=Pluralize(viewModelTypeName)#>.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.PutAsync($"api/<#=subjectName#>/<#=GetIdPath(subjectName, viewModelInstanceName)#>", string.Empty.ToJsonStringContent())).Result;

            // Assert
            Assert.AreEqual(System.Net.HttpStatusCode.BadRequest, result.StatusCode);
			<#+	WriteKeyAssert(subjectName, viewModelInstanceName); #>			
            Assert.AreEqual(<#=viewModelInstanceName#>.Name, this.dataService.<#=Pluralize(viewModelTypeName)#>.Single().Name);
        }

        [TestMethod]
        public void Update<#=subjectName#>_IdIsWrong_Returns404NotFound()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
                Name = "New<#=subjectName#>"
            };

            var updated<#=viewModelTypeName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t", viewModelInstanceName)#>,
                Name = "UpdatedNew<#=subjectName#>"
            };

            this.dataService.<#=Pluralize(viewModelTypeName)#>.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.PutAsync($"api/<#=subjectName#>/<#+ WriteInvalidIdPath(subjectName); #>", updated<#=viewModelTypeName#>.ToJsonStringContent())).Result;

            // Assert
            Assert.AreEqual(System.Net.HttpStatusCode.NotFound, result.StatusCode);
<#+			WriteKeyAssert(subjectName, viewModelInstanceName); #>			
            Assert.AreEqual(<#=viewModelInstanceName#>.Name, this.dataService.<#=Pluralize(viewModelTypeName)#>.Single().Name);
        }
		#endregion

<#+
}
#>

<#+
private void WriteDeleteTests(string unitUnderTestName, string subjectName, string viewModelTypeName, string viewModelInstanceName, string controllerObjectName)
{
#>
		#region Delete
		[TestMethod]
        public void Delete<#=subjectName#>_IdIsOk_Deletes<#=subjectName#>AndReturns204NoContent()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
                Name = "New<#=subjectName#>"
            };

            this.dataService.<#=Pluralize(viewModelTypeName)#>.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.DeleteAsync($"api/<#=subjectName#>/<#=GetIdPath(subjectName, viewModelInstanceName)#>")).Result;

            // Assert
            Assert.AreEqual(System.Net.HttpStatusCode.NoContent, result.StatusCode);
            Assert.AreEqual(0, this.dataService.<#=Pluralize(viewModelTypeName)#>.Count);
        }
        
        [TestMethod]
        public void Delete<#=subjectName#>_IdIsWrong_Returns404NotFound()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
            {
                <#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
                Name = "New<#=subjectName#>"
            };

            this.dataService.<#=Pluralize(viewModelTypeName)#>.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.DeleteAsync($"api/<#=subjectName#>/<#+ WriteInvalidIdPath(subjectName); #>")).Result;

            // Assert
            Assert.AreEqual(System.Net.HttpStatusCode.NotFound, result.StatusCode);
			<#+ WriteKeyAssert(subjectName, viewModelInstanceName); #>			
            Assert.AreEqual(<#=viewModelInstanceName#>.Name, this.dataService.<#=Pluralize(viewModelTypeName)#>.Single().Name);
        }
		#endregion

<#+
}
#>

<#+
private void WriteGetTests(string unitUnderTestName, string subjectName, string viewModelTypeName, string viewModelInstanceName, string controllerObjectName)
{
#>
		#region Get
		[TestMethod]
		public void Get<#= subjectName #>_ArgumentIsOk_CreatesObjectAndReturns200Ok()
		{
			// Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
			{
				<#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
				Name = "New<#=viewModelTypeName#>"
			};
			this.dataService.<#= subjectName #>ViewModels.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.GetAsync($"api/<#=subjectName#>/<#=GetIdPath(subjectName, viewModelInstanceName)#>")).Result;

            // Assert
			var content = result.Content.FromJsonString<<#=viewModelTypeName#>>();
			Assert.IsNotNull(result);
			Assert.IsNotNull(content);
            Assert.AreEqual(System.Net.HttpStatusCode.OK, result.StatusCode);
			<#+ WriteKeyAssert(subjectName, viewModelInstanceName, "content"); #>
			Assert.AreEqual(<#=viewModelInstanceName#>.Name, content.Name);
		}

		[TestMethod]
        public void Get<#=subjectName#>_WithInvalidId_Returns404NotFound()
        {
            // Arrange
            var <#=viewModelInstanceName#> = new <#=viewModelTypeName#>()
			{
				<#=GetNewIdProperties(subjectName, "\t\t\t\t")#>,
				Name = "New<#=viewModelTypeName#>"
			};
			this.dataService.<#= subjectName #>ViewModels.Add(<#=viewModelInstanceName#>);

            // Act
            var result = (httpClient.GetAsync("api/<#=subjectName#>/<#+ WriteInvalidIdPath(subjectName); #>")).Result;

            // Assert
			Assert.IsNotNull(result);
            Assert.AreEqual(System.Net.HttpStatusCode.NotFound, result.StatusCode);
        }
		#endregion

<#+
}
#>